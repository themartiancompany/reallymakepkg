#!/usr/bin/env bash
#
# SPDX-License-Identifier: AGPL-3.0

# System-independent makepkg
_reallymakepkg() {
  local \
    _args=()
  _args=(
    "$@")
  [[ -n "${TERMUX_VERSION}" ]] && \
    _termux_makepkg \
      "${_args[@]}" && \
    return
  makepkg \
    "${_args[@]}"
}

# Termux makepkg
# $@:makepkg args
_termux_makepkg() {
  local \
    _args=() \
    _pypattern
  _args=(
    "$@")
  _tmpdir="$( \
    mktemp \
      -d)"
  cp \
    -a \
    "$(pwd)"/* \
    "${_tmpdir}"
  sed \
    "s/pkgdir/terdir/g" \
    "$(pwd)/PKGBUILD" > \
    "${_tmpdir}/PKGBUILD"
  _pypattern="$( \
    cat \
      "${_tmpdir}/PKGBUILD" | \
      grep \
        -o \
        'root=[^ ]*terdir[^ ]*')"
  sed \
    -i \
    "s/${_pypattern}/root=\"\${pkgdir}\"/g" \
    "${_tmpdir}/PKGBUILD"
  cd \
    "${_tmpdir}"
  makepkg \
    "${_args[@]}"
  [[ *".pkg."* != "" ]] && \
    mv \
      *".pkg."* \
      "${OLDPWD}"
  cd \
    "${OLDPWD}"
  rm \
    -rf "${_tmpdir}"
}

_args=(
  "$@")

_reallymakepkg \
  "${_args[@]}"
